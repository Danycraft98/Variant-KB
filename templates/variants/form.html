{% extends 'base.html' %}
{% load custom_tags static %}

{% block style %}
    <link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/css/bootstrap-select.min.css'>
    <style>
        select, input[type='text'], textarea {
            display: block;
            width: 100%;
            height: calc(1.5em + .75rem + 2px);
            padding: .375rem .75rem;
            font-size: 1rem;
            font-weight: 400;
            line-height: 1.5;
            color: #495057;
            background-color: #fff;
            background-clip: padding-box;
            border: 1px solid #ced4da;
            border-radius: .25rem;
            transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out
        }
    </style>
{% endblock %}

{% block content %}
    <div class='page-header mt-4 d-flex flex-row align-items-center justify-content-between border-bottom'>
        <h3>{{ title }}</h3>
    </div>

    <div class='card my-5 card-body p-0'>
        {% include 'partials/_detail.html' %}
    </div>

    <div class='card my-5'>
        <form action='{% url 'variant' item.gene.name item.protein %}' method='POST'>
            {% csrf_token %}

            <div class='container-fluid m-0 p-0 row'>
                <div class='nav nav-tabs col-9 d-flex justify-content-start' id='nav-tab' role='tablist'>
                    {% with subform=form.empty_form %}
                        {% if subform|is_empty_form %}
                            <a class='empty-form nav-link active' id='empty_link' href='#{{ subform.prefix }}-div0' data-bs-toggle='tab' role='tab' aria-controls='nav-new' aria-selected='true'>New Interpretation</a>
                        {% endif %}
                    {% endwith %}

                    {% for subform in form.forms %}
                        {% if subform.name.value %}
                            <a class='nav-link' href='#{{ subform.prefix }}-div{{ forloop.counter0 }}' data-bs-toggle='tab' role='tab' aria-controls='nav-{{ subform.prefix }}' aria-selected='false'>
                                {{ subform.branch.value | upper }} Disease: {{ subform.name.value }}
                            </a>
                        {% endif %}
                    {% endfor %}
                </div>

                <div class='nav nav-tabs col-3 d-flex justify-content-end p-0' id='nav-tab' role='tablist'>
                    <a href='#' class='justify-content-end nav-link'>Add Interpretation</a>
                    <button type='submit' href='' class='justify-content-end nav-item nav-link'>Save</button>
                </div>

                <div class='p-0 tab-content' id='tab-content'>
                    <div id='management_forms'>
                        {{ form.management_form }}
                        {{ form.non_form_errors }}

                        {{ child_forms.0.management_form }}
                        {{ child_forms.1.management_form }}
                        {{ subchild_forms.0.management_form }}
                        {{ subchild_forms.1.management_form }}
                        {{ report_form.management_form }}
                    </div>

                    {% with subform=form.empty_form %}
                        {% for branch in branches %}
                            {% include 'partials/_disease.html' %}
                        {% endfor %}
                    {% endwith %}

                    {% for subform in form.forms %}
                        {% include 'partials/_disease.html' %}
                    {% endfor %}
                </div>
            </div>
        </form>
    </div>
{% endblock %}

{% block script %}
    <script src='{% static 'js/add_evidence.js' %}'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery.formset/1.2.2/jquery.formset.min.js' integrity='sha512-ltwjKsDTo3hW/wV66ZaEkf2wOAFxmg7rWM76J8kOcYKLSKy44WBYO/BFaNNH3NGDS8BSz3meB9wtSnm41oL+pA==' crossorigin='anonymous'></script>
    <script>
        function get_report(element) {
            const disease_id = element.id.split('_')[0];
            const disease_name = element.value;

            const xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function () {
                if (this.readyState === 4 && this.status === 200) {
                    const disease = JSON.parse(this.responseText)[0];
                    if (typeof disease !== 'undefined') { // && disease !== null) {
                        if (disease.hasOwnProperty('gene') && disease['gene'] === {{ item.gene.pk }}) {
                            document.getElementById(disease_id + '_gdr').value = disease['gdr'];
                        }

                        if (disease.hasOwnProperty('variant') && disease['variant'] === {{ item.pk }}) {
                            document.getElementById(disease_id + '_vdr').value = disease['vdr'];
                        }
                    } else {
                        document.getElementById(disease_id + '_gdr').value = '';
                    }
                }
            };
            xhttp.open('GET', '/api/disease/' + disease_name + '/', true);
            xhttp.send();
        }
    </script>
{% endblock %}