{% extends 'base.html' %}
{% load static %}

{% block style %}
    <link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/css/bootstrap-select.min.css'>
    <style>
        select, input[type='text'], textarea {
            display: block;
            width: 100%;
            height: calc(1.5em + .75rem + 2px);
            padding: .375rem .75rem;
            font-size: 1rem;
            font-weight: 400;
            line-height: 1.5;
            color: #495057;
            background-color: #fff;
            background-clip: padding-box;
            border: 1px solid #ced4da;
            border-radius: .25rem;
            transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out
        }
    </style>
{% endblock %}

{% block content %}
    <div class='card mt-4'>
        <div class='card-header d-flex'>
            <h5 class='mr-auto my-auto'><strong>{{ title }}</strong></h5>
        </div>
        <form action='{% url 'variant' item.gene.name item.protein %}' method='post'>
            {% csrf_token %}
            <div class='card-body'>
                {% csrf_token %}
                <fieldset class='card-body container'>
                    {% include 'partials/_detail.html' %}

                    {% for form in forms %}
                        {{ form.management_form }}
                        {{ form.non_form_errors }}
                    {% endfor %}

                    <div class='card my-5'>
                        <div class='errors'>
                            {% for form in forms %}
                                {{ form.errors }}
                            {% endfor %}
                        </div>

                        <div class='nav nav-tabs'>
                            {% with form=forms.1 %}
                                <a class='empty-form nav-item nav-link active' href='#{{ form.empty_form.branch.value }}' data-toggle='tab'>New Interpretation</a>
                            {% endwith %}
                            {% for form in forms %}
                                {% for subform in form %}
                                    {% if subform.name.value %}
                                        <a class='nav-item nav-link' href='#{{ subform.prefix }}' data-toggle='tab'>
                                            Disease: {{ subform.name.value }}
                                        </a>
                                    {% endif %}
                                {% endfor %}
                            {% endfor %}
                            <button type='submit' href='' class='ml-auto nav-item nav-link'>Save</button>
                        </div>

                        <div class='tab-content'>
                            {% for form in forms %}
                                {% if form == forms.1 %}
                                    {% with subform=form.empty_form %}
                                        {% include 'partials/_disease.html' %}
                                    {% endwith %}
                                {% endif %}

                                {% for subform in form %}
                                    {% include 'partials/_disease.html' %}
                                {% endfor %}
                            {% endfor %}
                        </div>
                    </div>
                </fieldset>
            </div>
        </form>
    </div>
{% endblock %}

{% block script %}
    <!--script src='https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/js/bootstrap-select.min.js'></script-->
    <!--script src='https://cdnjs.cloudflare.com/ajax/libs/jquery.formset/1.2.2/jquery.formset.min.js' integrity='sha512-ltwjKsDTo3hW/wV66ZaEkf2wOAFxmg7rWM76J8kOcYKLSKy44WBYO/BFaNNH3NGDS8BSz3meB9wtSnm41oL+pA==' crossorigin='anonymous'></script-->
    <!--script src='{% static 'js/add_evidence.js' %}'></script-->

    <script>
        /*document.ready(function () {
            $('#functionals-__prefix__').addClass('active');
            $('.required').prop('required', function () {
                return $(this).is(':visible');
            });
        });*/

        function get_report(element) {
            const disease_id = element.id.split('_')[0];
            const disease_name = element.value;

            const xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function () {
                if (this.readyState === 4 && this.status === 200) {
                    const disease = JSON.parse(this.responseText)[0];
                    if (typeof disease !== 'undefined') { // && disease !== null) {
                        if (disease.hasOwnProperty('gene') && disease['gene'] === {{ item.gene.pk }}) {
                            document.getElementById(disease_id + '_gdr').value = disease['gdr'];
                        }

                        if (disease.hasOwnProperty('variant') && disease['variant'] === {{ item.pk }}) {
                            document.getElementById(disease_id + '_vdr').value = disease['vdr'];
                        }
                    } else {
                        document.getElementById(disease_id + '_gdr').value = '';
                    }
                }
            };
            xhttp.open('GET', '/api/disease/' + disease_name + '/', true);
            xhttp.send();
        }

        function change_disease(element) {
            const name_str = element.lastElementChild.firstElementChild.firstElementChild.getAttribute('name')
            console.log($('input[name="' + name_str + '"]:checked').val());
        }

        function copyReport(item) {
            Array.prototype.forEach.call(document.getElementsByName(item.name), function (element) {
                element.value = item.value;
            });
        }
    </script>
{% endblock %}