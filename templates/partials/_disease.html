{% load custom_tags mathfilters %}


<div class='tab-pane fade {% if subform|is_empty_form %}{% if branch == 'no' %}show active{% endif %} empty-form{% endif %}' {% if branch %}data-key='{{ branch }}'{% endif %} id='{{ subform.prefix }}-div{{ forloop.counter0 }}' role='tabpanel' aria-labelledby='{{ subform.prefix }}-tab'>
    {{ subform.management_form }}

    <div id='{{ subform.prefix }}-label' class='card-header container-fluid row m-0'>
        <div class='h6 col-8 d-flex justify-content-start my-2'>
            {% if subform|is_empty_form %}[Disease] / [Status]{% else %}{{ subform.name.value }} / {{ subform.reviewed|data_verbose }}{% endif %}
        </div>

        <div class='col-4 d-flex justify-content-end form-check-inline' style='margin-right: 0'>
            <label class='h6 my-auto' for='{{ subform.branch.id_for_label }}'>{{ subform.branch.label }}:</label>

            <label class='h6 my-auto'>
                {% if not subform|is_empty_form %}
                    {{ subform.branch|data_verbose }}
                {% endif %}

                <fieldset {% if not 'prefix' in subform.name.id_for_label %}hidden{% endif %} onchange='change_disease(this.firstElementChild)'>
                    {{ subform.branch }}
                </fieldset>
            </label>
        </div>
    </div>

    <div id='{{ subform.prefix }}-div' class='card-body container {% if subform|is_empty_form %}empty-form{% endif %}'>
        {% if subform.branch.value != 'no' %}{# or branch != 'no' %} #}
            {{ subform.id }}

            <div class='row my-2'>
                <div class='col-4'>{{ subform.name.label }}</div>
                <div class='col-5'>{{ subform.name }}</div>
                <div class='offset-md-1 col-2'>{{ subform.DELETE }} {{ subform.DELETE.label }}</div>
            </div>

            {% if subform.branch.value == 'so' %}

                {% with index=forloop.counter0|sub:gp_count %}

                    {% with func=child_forms.0.forms|get_index:index %}

                        {{ func.id }}
                        <div class='row form-group my-2'>
                            <div class='col-4'>{{ func.key.label }}</div>
                            <div class='col-4'>{{ func.key }}</div>
                            <div class='offset-md-1 col-3 pr-3'>
                                <button type='button' id='{{ func.prefix }}_cat{{ index }}' class='btn btn-primary pull-right' onclick='add_func_cat(this)'>Add Functional Category</button>
                            </div>
                        </div>
                    </div>

                    <div id='func_cat'>
                        <div class='card-header border-top justify-content-between d-flex'>
                            <div class='h6 mr-auto my-auto'>Functional Evidences</div>

                            <div class='ml-auto'>
                                <button type='button' class='btn btn-primary' id='{{ func.prefix }}_evid{{ forloop.counter }}' onclick='add_evid(this)'>Add Functional Evidences</button>
                            </div>
                        </div>

                        <div class='func_evid d{{ form.name.id_for_label }}_func collapse show'>
                            <div id='form{{ form.name }}' class='card-body container border-bottom'>
                                <div class='row form-group my-2'>
                                    <div class='col-4'>{{ func.value.label }}</div>
                                    <div class='col-4'>{{ func.value }}</div>
                                </div>
                            </div>

                            {% for evid in subchild_forms.0 %}
                                <div id='form{{ evid.name }}' class='card-body container'>
                                    {{ evid.id }}
                                    {% include 'partials/_evidence.html' %}
                                </div>
                            {% endfor %}
                        </div>
                    </div>

                    {% endwith %}

                {% endwith %}

                <div id='act_evid'>
                    <div class='card-header border-top justify-content-between d-flex'>
                        <div class='h6 mr-auto my-auto'>Actionability Evidences</div>

                        <button type='button' id='{{ subform.prefix }}_evid{{ forloop.counter }}' class='ml-auto btn btn-primary' onclick='add_evid(this)'>Add Actionability Evidences</button>
                    </div>

                    <div class='act_evid {{ subchild_forms.0.prefix }}_evid collapse show'>
                        <div class='card-body container {% if 'prefix' in subform.name.id_for_label %}empty-form{% endif %} border-bottom'>
                            <div class='row form-group my-2'>
                                <div class='col-4'>{{ subform.others.label }}</div>
                                <div class='col-4'>{{ subform.others }}</div>
                            </div>
                        </div>

                        {% with index=forloop.counter0|sub:gp_count %}
                            {% with evid=subchild_forms.0.forms|get_index:index %}
                                <div id='inner_form{{ forloop.counter }}' class='card-body container {% if 'prefix' in form.name.id_for_label %}empty-form{% endif %}'>
                                    {% include 'partials/_evidence.html' %}

                                    <div class='row my-2'>
                                        <div class='col-4'>Evidence Significance</div>
                                        <div class='col-4'>
                                            <input class='form-control' id='id_{{ evid.prefix }}-evid_sig{{ index }}' name='{{ evid.prefix }}-evid_sig' aria-label='Evidence Significance'>
                                        </div>
                                    </div>

                                    <div class='row my-2'>
                                        <div class='col-4'>Evidence Level</div>
                                        <div class='col-4'>
                                            <input class='form-control' id='id_{{ evid.prefix }}-level{{ index }}' name='{{ evid.prefix }}-level' aria-label='Evidence Level'>
                                        </div>
                                    </div>

                                    <div class='row my-2'>
                                        <div class='col-4'>Evidence Direction</div>
                                        <div class='col-4'>
                                            <input class='form-control' id='id_{{ evid.prefix }}-evid_dir{{ index }}' name='{{ evid.prefix }}-evid_dir' aria-label='Evidence Direction'>
                                        </div>
                                    </div>

                                    <div class='row my-2'>
                                        <div class='col-4'>Clinical Significance</div>
                                        <div class='col-4'>
                                            <input class='form-control' id='id_{{ evid.prefix }}-clin_sig{{ index }}' name='{{ evid.prefix }}-clin_sig' aria-label='Evidence Direction'>
                                        </div>
                                    </div>

                                    <div class='row my-2'>
                                        <div class='col-4'>Drug/Drug Class/Dx</div>
                                        <div class='col-4'>
                                            <input class='form-control' id='id_{{ evid.prefix }}-drug_class{{ index }}' name='{{ evid.prefix }}-drug_class' aria-label='Drug/Drug Class/Dx'>
                                        </div>
                                    </div>

                                    <div class='row my-2'>
                                        <div class='col-4'>Evidence Rating</div>
                                        <div class='col-4'>
                                            <input class='form-control' id='id_{{ evid.prefix }}-evid_rating{{ index }}' name='{{ evid.prefix }}-evid_rating' aria-label='Evidence Rating'>
                                        </div>
                                    </div>

                                    <hr/>
                                </div>
                            {% endwith %}
                        {% endwith %}
                    </div>
                </div>

            {% elif subform.branch.value == 'gp'  %}

                {% with index=forloop.counter0 %}

                    <div class='row form-group my-2'>
                        <div class='col-4'>{{ subform.report.label }}</div>
                        <div class='col-4'>{{ subform.report }}</div>
                    </div>
                </div>

                {% endwith %}

                {% with score=child_forms.1.forms|get_index:forloop.counter0 %}

                    <div id='score'>
                        <div class='card-header justify-content-between'>
                            <div class='h6 mr-auto my-2'>2015 ACMG Score</div>
                        </div>

                        {{ score.id }}
                        <div id='d{{ score.name.id_for_label }}_score' class='card-body container {% if 'prefix' in form.name.id_for_label %}empty-form{% endif %}'>
                            {{ form.child_id }}
                            <div class='row form-group my-2'>
                                <div class='col-4'>{{ score.content.label }}</div>
                                <div class='col-4'>{{ score.content }}</div>
                            </div>

                            <div class='row form-group my-2'>
                                <div class='col-4'>{{ score.for_score.label }}</div>
                                <div class='col-4'>{{ score.for_score }}</div>
                            </div>

                            <div class='row form-group my-2'>
                                <div class='col-4'>{{ score.against_score.label }}</div>
                                <div class='col-4'>{{ score.against_score }}</div>
                            </div>
                        </div>
                    </div>

                {% endwith %}


                <div id='score_items'>
                    {% regroup subchild_forms.1.forms by key.value.0 as sorted_forms %}

                    {% for form in sorted_forms %}
                        <div class='card-header border-top h6 mr-auto my-2'>
                            {% if form.grouper == 'P' %}For{% else %}Against{% endif %} Pathogenicity
                        </div>

                        {% for evid in form.list %}
                            <div class='card-body container'>
                                <div class='row my-3'>
                                    <div class='col-12'>
                                        <input type='checkbox' id='{{ evid.key.id_for_label }}' name='{{ evid.key.name }}' value='{{ evid.value.value }}' onchange='select_evidence(this, "{{ child_forms.1.0.prefix }}")' aria-label='{{ evid.key.value }}'/>
                                        {{ evid.key.value }}: {{ evid.content.value }}
                                    </div>
                                </div>

                                <fieldset id='{{ evid.key.id_for_label }}_evid' disabled>
                                    {% include 'partials/_evidence.html' %}
                                </fieldset>
                            </div>

                        {% endfor %}

                    {% endfor %}
                </div>

            {% endif %}

            <div id='d{{ subform.name.id_for_label }}_label' class='card-header container-fluid'>
                <div class='row my-2 mx-0 h6'>Review</div>
            </div>

            <div id='{{ report_form.0.prefix }}-div' class='card-body container {% if 'prefix' in subform.name.id_for_label %}empty-form{% endif %}'>
                <div class='form-group'>
                    {% for item, review in subform.reviewed.field.choices|zip_list:subform.reviewed %}
                        <div class='form-check form-check-inline'>
                            <input id='{{ review.id_for_label }}' name='{{ subform.prefix }}-{{ subform.reviewed.name }}' class='form-check-input' type='checkbox' value='{{ item.0 }}' onchange='set_reviewed(this)' {% if forloop.counter0 == 0 %}hidden{% endif %}/>
                            <label for='{{ review.id_for_label }}' class='form-check-label' {% if forloop.counter0 == 0 %}hidden{% endif %}>{{ item.1 }}</label>
                        </div>
                    {% endfor %}

                    <label hidden>{{ subform.reviewed }}</label>
                </div>

                <hr class='double-hr'/>

                {% with curation=report_form.6 %}
                    <div class='row my-2'>
                        <div class='col-4'>
                            <label for='{{ curation.id_for_label }}'>Curation Notes</label>
                        </div>
                        <div class='col-5'>{{ curation.content }}</div>
                        <div class='col-3'>
                            <input type='hidden' id='{{ curation.id_for_label }}' name='{{ curation.prefix }}-name' value='Curation Notes'/>
                        </div>
                    </div>
                {% endwith %}
                {{ report_form.content }}
            </div>
        {% else %}

    </div>

        {% endif %}
</div>


{% comment %}

    <!--{% if form.errors %}
            {% for field in form %}
                {% for error in field.errors %}
                    <div class="alert alert-danger">
                        <strong>{{ error|escape }}</strong>
                    </div>
                {% endfor %}
            {% endfor %}
            {% for error in form.non_field_errors %}
                <div class="alert alert-danger">
                    <strong>{{ error|escape }}</strong>
                </div>
            {% endfor %}
        {% endif %}-->

    {% if subform.branch.value != 'no' or branch != 'no' %}

        <div id='{{ form.prefix }}div' class='card-body container {% if 'prefix' in subform.name.id_for_label %}empty-form{% endif %}'>
            {{ subform.id }}



            {% if subform.branch.value == 'so' or branch == 'so' %}
                {% with index=forloop.counter0|sub:gp_count %}
                    {% with func=child_forms.0.forms|get_index:index %}
                        {{ func.id }}
                        {% if forloop.counter0 == 0 %}
                            <div class='row form-group my-2'>
                                <div class='col-4'>{{ func.key.label }}</div>
                                <div class='col-4'>{{ func.key }}</div>
                                <div class='offset-md-1 col-3 pr-3'>
                                    <button type='button' id='{{ func.prefix }}_cat{{ index }}' class='btn btn-primary pull-right' onclick='add_func_cat(this)'>Add Functional Category</button>
                                </div>
                            </div>
                            </div>
                        {% endif %}


                        </div>
                    {% endwith %}
                {% endwith %}
                </div>


                <!--
                <div id='reports'>
                    <div class='card-header border-top justify-content-between d-flex'>
                        <div class='h6 my-auto'>Reports</div>
                    </div>

                    <div id='{{ report_form.0.prefix }}-div' class='card-body container {% if 'prefix' in subform.name.id_for_label %}empty-form{% endif %}'>
                        {% for subform, name in report_form|zip_list:reports %}
                            {% if forloop.counter0 != 6 %}
                                <div class='row my-2'>
                                    <div class='col-4'>{{ name }}</div>
                                    <div class='col-5'>{{ subform.content }}</div>
                                    <div class='col-3'>
                                        <input type='hidden' id='{{ subform.id_for_label }}' name='{{ subform.prefix }}-name' value='{{ name }}'/>
                                    </div>
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
                -->

            {% else %}


                </div>





            {% endif %}

        <div id='d{{ subform.name.id_for_label }}_label' class='card-header container-fluid'>
            <div class='row my-2'>
                <div class='h6 col-9 d-flex justify-content-start'>
                    Review
                </div>
            </div>
        </div>



    {% endif %}
</div>
{% endcomment %}